# .Synopsis
#     Terraform linter pipeline
#
# .NOTES
#     Author     : Roman Rabodzei
#     Version    : 1.0.240616
#
#             _
#         .__(.)<  (MEOW)
#          \___)
#  ~~~~~~~~~~~~~~~~~~~~~~~~

name: Terraform Linter pipeline

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

jobs:
  - deployment: terraform_linter
    displayName:  Terraform Linter job
    environment: 'linter'
    strategy:
      runOnce:
        deploy:
          steps:
            # Checkout the repository to the Azure DevOps agent
            - checkout: self
              fetchDepth: 0

            # Install the preferred version of Terraform CLI
            - task: CmdLine@2
              displayName: 'Setup Terraform'
              inputs:
                script: |
                  sudo apt-get update && sudo apt-get install -y gnupg software-properties-common
                  wget -O- https://apt.releases.hashicorp.com/gpg | \ 
                    gpg --dearmor | \ 
                    sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null
                  gpg --no-default-keyring \
                    --keyring /usr/share/keyrings/hashicorp-archive-keyring.gpg \
                    --fingerprint
                  echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
                    https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \ 
                    sudo tee /etc/apt/sources.list.d/hashicorp.list
                  sudo apt update
                  sudo apt install terraform
                workingDirectory: '$(system.defaultWorkingDirectory)'
                failOnStderr: true

            # Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.
            - task: CmdLine@2
              displayName: 'Terraform Init'
              inputs:
                script: |
                  terraform init -backend=false
                workingDirectory: '$(system.defaultWorkingDirectory)'
                failOnStderr: true

            # Run a terraform fmt for push
            - task: CmdLine@2
              displayName: 'Terraform Format'
              inputs:
                script: |
                  terraform fmt -recursive -check
                workingDirectory: '$(system.defaultWorkingDirectory)'
                failOnStderr: true

            # Run a terraform validate
            # Run even if formatting fails
            - task: CmdLine@2
              displayName: 'Terraform Validate'
              inputs:
                script: |
                  terraform validate
                workingDirectory: '$(system.defaultWorkingDirectory)'
                failOnStderr: true
              condition: succeededOrFailed()
